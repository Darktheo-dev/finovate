<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Stock Tracker with Graph</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #f2f2f2;
        text-align: center;
        padding: 20px;
      }

      .container {
        background: white;
        padding: 30px;
        max-width: 700px;
        margin: auto;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }

      input,
      select,
      button {
        padding: 10px;
        margin: 10px;
        font-size: 1em;
      }

      button {
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      button:hover {
        background-color: #0056b3;
      }

      .error {
        color: red;
        font-weight: bold;
      }

      #spinner {
        display: none;
        margin: 20px auto;
      }

      .loader {
        border: 6px solid #f3f3f3;
        border-top: 6px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ðŸ“ˆ Simple Stock Tracker</h1>
      <input type="text" id="searchInput" placeholder="Search for Company" />
      <button onclick="searchCompanies()">Search</button>

      <select
        id="symbolSelect"
        onchange="fetchStockData()"
        style="display: none"
      ></select>

      <div id="spinner"><div class="loader"></div></div>

      <div id="stockInfo" style="display: none">
        <h2 id="stockName"></h2>
        <p id="stockDetails"></p>
        <p id="stockPrice"></p>
        <label for="dayRange">Past Days:</label>
        <select id="dayRange" onchange="fetchStockData()">
          <option value="7">7</option>
          <option value="14" selected>14</option>
          <option value="30">30</option>
        </select>
        <canvas id="stockChart" width="600" height="400"></canvas>
      </div>

      <p id="error" class="error"></p>
    </div>
    <script src="config.js"></script>
    <script src="script.js"></script>

    <script>
      const apiKey = API_KEY;
      let chart;

      async function searchCompanies() {
        const query = document.getElementById("searchInput").value.trim();
        const select = document.getElementById("symbolSelect");
        select.innerHTML = "";

        if (!query) {
          alert("Please enter a company name.");
          return;
        }

        const url = `https://api.twelvedata.com/symbol_search?symbol=${query}&apikey=${apiKey}`;
        try {
          const response = await fetch(url);
          const data = await response.json();

          if (!data || !data.data || data.data.length === 0) {
            document.getElementById("error").textContent =
              "No matching companies found.";
            return;
          }

          const sorted = data.data.sort((a, b) => {
            const aUS = a.symbol.endsWith(".US") ? -1 : 1;
            const bUS = b.symbol.endsWith(".US") ? -1 : 1;
            return aUS - bUS;
          });

          for (const entry of sorted) {
            const opt = document.createElement("option");
            opt.value = entry.symbol;
            opt.textContent = `${entry.instrument_name} (${entry.symbol})`;
            select.appendChild(opt);
          }

          select.style.display = "inline-block";
          fetchStockData();
        } catch (err) {
          console.error(err);
          document.getElementById("error").textContent =
            "Error fetching company list.";
        }
      }

      async function fetchStockData() {
        const symbol = document.getElementById("symbolSelect").value;
        const days = document.getElementById("dayRange").value;
        const url = `https://api.twelvedata.com/time_series?symbol=${symbol}&interval=1day&outputsize=${days}&apikey=${apiKey}`;

        document.getElementById("spinner").style.display = "block";
        document.getElementById("error").textContent = "";
        document.getElementById("stockInfo").style.display = "none";

        try {
          const response = await fetch(url);
          const data = await response.json();
          document.getElementById("spinner").style.display = "none";

          if (data.status === "error" || !data.values) {
            document.getElementById("error").textContent =
              "Error: " + (data.message || "Invalid symbol or API error.");
            return;
          }

          const labels = data.values.map((item) => item.datetime).reverse();
          const prices = data.values
            .map((item) => parseFloat(item.close))
            .reverse();

          document.getElementById("stockName").textContent = `${
            data.meta.symbol
          } â€” ${data.meta.name || ""}`;
          document.getElementById(
            "stockDetails"
          ).textContent = `Last Updated: ${data.meta.last_updated || "N/A"}`;
          document.getElementById("stockPrice").textContent = `Latest Price: $${
            prices[prices.length - 1]
          }`;
          document.getElementById("stockInfo").style.display = "block";

          renderChart(labels, prices, data.meta.symbol);
        } catch (err) {
          document.getElementById("spinner").style.display = "none";
          document.getElementById("error").textContent = "Error fetching data.";
        }
      }

      function renderChart(labels, dataPoints, symbol) {
        const ctx = document.getElementById("stockChart").getContext("2d");
        if (chart) chart.destroy();
        chart = new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: `${symbol} Closing Prices`,
                data: dataPoints,
                borderColor: "rgba(75, 192, 192, 1)",
                backgroundColor: "rgba(75, 192, 192, 0.2)",
                fill: true,
                tension: 0.3,
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              x: { title: { display: true, text: "Date" } },
              y: { title: { display: true, text: "Price (USD)" } },
            },
          },
        });
      }
      // Auto-refresh every 30 seconds
      setInterval(() => {
        const symbol = document.getElementById("symbolSelect").value;
        if (symbol) {
          fetchStockData(); // re-fetch latest price and chart
        }
      }, 60000); // 30000 ms = 60 seconds
    </script>
  </body>
</html>
