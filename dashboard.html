<!DOCTYPE html>
<html>
  <head>
    <title>Lucre - Mission Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      /* --- CSS Styles (Unchanged but minified for cleanliness) --- */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        background: #0a0a0a;
        color: white;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          monospace;
        text-align: center;
        padding: 20px;
      }
      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: linear-gradient(145deg, #1a1a1a, #151515);
        border-radius: 20px;
        padding: 40px;
        border: 1px solid #2a2a2a;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
      }
      h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
      }
      h2 {
        font-size: 1.4rem;
        margin-top: 40px;
        margin-bottom: 20px;
        color: #aaa;
        font-weight: 400;
        text-align: left;
      }
      .charts-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-top: 30px;
      }
      @media (max-width: 968px) {
        .charts-container {
          grid-template-columns: 1fr;
        }
      }
      .chart-wrapper {
        background: #1a1a1a;
        border-radius: 16px;
        padding: 25px;
        border: 1px solid #2a2a2a;
        height: 450px;
        position: relative;
      }
      /* Important: Allow canvas to fill parent */
      canvas {
        width: 100% !important;
        height: 100% !important;
      }
      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
        gap: 20px;
        margin: 30px 0;
      }
      .stat {
        background: linear-gradient(145deg, #252525, #1a1a1a);
        padding: 20px 15px;
        border-radius: 16px;
        text-align: center;
        color: #888;
        border: 1px solid #2a2a2a;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      }
      .stat strong {
        display: block;
        font-size: 2.2rem;
        color: #fff;
        margin-top: 10px;
        font-weight: 600;
      }
      button {
        margin-top: 30px;
        padding: 16px 36px;
        background: linear-gradient(135deg, #007aff, #0056b3);
        color: white;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        font-size: 1.1rem;
        font-weight: 600;
        transition: all 0.3s;
      }
      button:hover {
        background: linear-gradient(135deg, #0056b3, #003d82);
        transform: translateY(-2px);
      }
      .phase {
        font-size: 1.6rem;
        margin: 20px 0;
        color: #00ff88;
        font-weight: 500;
        min-height: 1.6rem;
      }
      .anomaly-alert {
        color: #ff3b30 !important;
        font-weight: bold;
        animation: pulse 1s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.02);
        }
      }
      .mode-badge {
        display: inline-block;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-left: 12px;
        text-transform: uppercase;
        letter-spacing: 1px;
        vertical-align: middle;
      }
      .mode-predictive {
        background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
        box-shadow: 0 2px 10px rgba(255, 107, 107, 0.3);
      }
      .mode-comparative {
        background: linear-gradient(135deg, #4facfe, #00f2fe);
        box-shadow: 0 2px 10px rgba(79, 172, 254, 0.3);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 id="missionTitle">Mission Dashboard</h1>
      <div class="phase" id="phase">Initializing Connection...</div>

      <div class="stats">
        <div class="stat">Altitude<strong id="altitude">0.0 km</strong></div>
        <div class="stat">Velocity<strong id="velocity">0 m/s</strong></div>
        <div class="stat">Thrust<strong id="thrust">0 kN</strong></div>
        <div class="stat">Propellant<strong id="fuel">100.00%</strong></div>
      </div>

      <div class="charts-container">
        <div class="chart-wrapper">
          <h2 id="systemsTitle">Propellant Analysis</h2>
          <canvas id="chartSystems"></canvas>
        </div>
        <div class="chart-wrapper">
          <h2>Flight Dynamics</h2>
          <canvas id="chartDynamics"></canvas>
        </div>
      </div>

      <button onclick="window.location.reload()">Reset Simulation</button>
    </div>

    <script>
      let socket;

      // --- Chart Styling Config ---
      const fontConfig = {
        title: {
          display: true,
          color: "#999",
          font: { size: 13, weight: "500", family: "monospace" },
        },
        ticks: { color: "#777", font: { size: 11, family: "monospace" } },
        grid: {
          color: "rgba(100, 100, 100, 0.2)",
          lineWidth: 1,
          borderDash: [5, 5],
        },
        border: { display: true, color: "#555", width: 1 },
      };

      const commonOptions = {
        animation: false,
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: "index", intersect: false },
        plugins: {
          legend: {
            labels: { color: "#ccc", usePointStyle: true, boxWidth: 8 },
          },
          tooltip: {
            backgroundColor: "rgba(20, 20, 20, 0.95)",
            titleFont: { family: "monospace" },
            bodyFont: { family: "monospace" },
            borderColor: "#444",
            borderWidth: 1,
            callbacks: {
              title: (items) => `T+ ${items[0].parsed.x.toFixed(1)}s`,
            },
          },
        },
      };

      // --- Initialize Charts ---
      const ctxSystems = document
        .getElementById("chartSystems")
        .getContext("2d");
      const systemsChart = new Chart(ctxSystems, {
        type: "line",
        data: { datasets: [] },
        options: {
          ...commonOptions,
          scales: {
            x: {
              type: "linear",
              min: 0,
              max: 165,
              title: { ...fontConfig.title, text: "Mission Time (s)" },
              ticks: fontConfig.ticks,
              grid: fontConfig.grid,
              border: fontConfig.border,
            },
            y: {
              min: 0,
              max: 100,
              title: { ...fontConfig.title, text: "Propellant %" },
              ticks: fontConfig.ticks,
              grid: fontConfig.grid,
              border: fontConfig.border,
            },
          },
        },
      });

      const ctxDynamics = document
        .getElementById("chartDynamics")
        .getContext("2d");
      const dynamicsChart = new Chart(ctxDynamics, {
        type: "line",
        data: { datasets: [] },
        options: {
          ...commonOptions,
          scales: {
            x: {
              type: "linear",
              min: 0,
              max: 165,
              title: { ...fontConfig.title, text: "Mission Time (s)" },
              ticks: fontConfig.ticks,
              grid: fontConfig.grid,
              border: fontConfig.border,
            },
            y: {
              type: "linear",
              position: "left",
              suggestedMax: 100, // Auto-scale if we go higher
              title: { ...fontConfig.title, text: "Altitude (km)" },
              ticks: fontConfig.ticks,
              grid: fontConfig.grid,
              border: fontConfig.border,
            },
            y1: {
              type: "linear",
              position: "right",
              suggestedMax: 2000, // Auto-scale if we go faster
              title: { ...fontConfig.title, text: "Velocity (m/s)" },
              ticks: fontConfig.ticks,
              grid: { drawOnChartArea: false }, // Hide grid for 2nd axis
              border: fontConfig.border,
            },
          },
        },
      });

      // --- Main Logic ---
      window.addEventListener("load", () => {
        // Safe Socket URL detection
        const socketUrl =
          window.location.hostname === "localhost" ||
          window.location.protocol === "file:"
            ? "http://localhost:3000"
            : "/"; // Relative path if hosted normally

        // Check if IO loaded
        if (typeof io === "undefined") {
          document.getElementById("phase").textContent =
            "Error: Socket.IO Library Failed";
          document.getElementById("phase").style.color = "#ff3b30";
          return;
        }

        socket = io(socketUrl);

        // Simulation Mode Setup
        const simMode = localStorage.getItem("simMode") || "predictive";
        const customParams =
          JSON.parse(localStorage.getItem("customRocketParams")) || {};

        const modeText =
          simMode === "predictive"
            ? "Predictive Analysis"
            : "Comparative Analysis";
        document.getElementById(
          "missionTitle"
        ).innerHTML = `${modeText} <span class="mode-badge mode-${simMode}">${simMode}</span>`;

        // Initialize Datasets based on Mode
        if (simMode === "predictive") {
          document.getElementById("systemsTitle").textContent =
            "Propellant Anomaly Detection";
          systemsChart.data.datasets = [
            {
              label: "Actual",
              data: [],
              borderColor: "#00d4ff",
              borderWidth: 2,
              pointRadius: 0,
            },
            {
              label: "Nominal",
              data: [],
              borderColor: "#666",
              borderWidth: 1,
              borderDash: [5, 5],
              pointRadius: 0,
            },
          ];
          dynamicsChart.data.datasets = [
            {
              label: "Altitude",
              data: [],
              borderColor: "#ffaa00",
              yAxisID: "y",
              borderWidth: 2,
              pointRadius: 0,
            },
            {
              label: "Velocity",
              data: [],
              borderColor: "#ff4466",
              yAxisID: "y1",
              borderWidth: 2,
              pointRadius: 0,
            },
          ];
        } else {
          document.getElementById("systemsTitle").textContent =
            "Propellant Comparison";
          systemsChart.data.datasets = [
            {
              label: "Your Rocket",
              data: [],
              borderColor: "#00d4ff",
              borderWidth: 2,
              pointRadius: 0,
            },
            {
              label: "Falcon 9",
              data: [],
              borderColor: "#666",
              borderWidth: 1,
              borderDash: [5, 5],
              pointRadius: 0,
            },
          ];
          dynamicsChart.data.datasets = [
            {
              label: "Your Alt",
              data: [],
              borderColor: "#ffaa00",
              yAxisID: "y",
              borderWidth: 2,
              pointRadius: 0,
            },
            {
              label: "F9 Alt",
              data: [],
              borderColor: "rgba(255, 170, 0, 0.4)",
              yAxisID: "y",
              borderDash: [5, 5],
              borderWidth: 1,
              pointRadius: 0,
            },
            {
              label: "Your Vel",
              data: [],
              borderColor: "#ff4466",
              yAxisID: "y1",
              borderWidth: 2,
              pointRadius: 0,
            },
            {
              label: "F9 Vel",
              data: [],
              borderColor: "rgba(255, 68, 102, 0.4)",
              yAxisID: "y1",
              borderDash: [5, 5],
              borderWidth: 1,
              pointRadius: 0,
            },
          ];
        }
        systemsChart.update();
        dynamicsChart.update();

        // --- Socket Events ---
        socket.on("connect", () => {
          console.log("Connected to Flight Computer");
          document.getElementById("phase").textContent =
            "Standby for Launch...";
          document.getElementById("phase").style.color = "#00ff88";
          document.getElementById("phase").classList.remove("anomaly-alert");

          // Start the sim immediately on connect
          socket.emit("start-simulation", {
            mode: simMode,
            params: customParams,
          });

          // Clear storage to prevent sticky settings
          localStorage.removeItem("simMode");
          localStorage.removeItem("customRocketParams");
        });

        socket.on("data", (d) => {
          if (!d || !d.display) return; // Safety check

          const { display: disp, nominal: nom } = d;

          // Update DOM
          document.getElementById("altitude").textContent = `${(
            disp.altitude / 1000
          ).toFixed(1)} km`;
          document.getElementById("velocity").textContent = `${Math.round(
            disp.velocity
          )} m/s`;
          document.getElementById("thrust").textContent = `${Math.round(
            disp.thrust
          )} kN`;
          document.getElementById("fuel").textContent = `${disp.fuel.toFixed(
            1
          )}%`;

          // Phase / Anomaly Text
          const phaseEl = document.getElementById("phase");
          if (d.anomaly) {
            phaseEl.textContent = d.anomaly;
            phaseEl.classList.add("anomaly-alert");
          } else {
            phaseEl.classList.remove("anomaly-alert");
            phaseEl.textContent = `T+ ${d.time.toFixed(1)}s`;
            // Color coding based on flight phase
            if (d.time < 70) phaseEl.style.color = "#00ff88"; // Green (Ascent)
            else if (disp.fuel > 0)
              phaseEl.style.color = "#ffaa00"; // Orange (MaxQ/Burn)
            else phaseEl.style.color = "#ff4444"; // Red (MECO)
          }

          // Push to Charts
          const t = d.time;

          if (simMode === "predictive") {
            systemsChart.data.datasets[0].data.push({ x: t, y: disp.fuel });
            systemsChart.data.datasets[1].data.push({ x: t, y: nom.fuel });

            dynamicsChart.data.datasets[0].data.push({
              x: t,
              y: disp.altitude / 1000,
            });
            dynamicsChart.data.datasets[1].data.push({
              x: t,
              y: disp.velocity,
            });
          } else {
            systemsChart.data.datasets[0].data.push({ x: t, y: disp.fuel });
            systemsChart.data.datasets[1].data.push({ x: t, y: nom.fuel });

            dynamicsChart.data.datasets[0].data.push({
              x: t,
              y: disp.altitude / 1000,
            });
            dynamicsChart.data.datasets[1].data.push({
              x: t,
              y: nom.altitude / 1000,
            });
            dynamicsChart.data.datasets[2].data.push({
              x: t,
              y: disp.velocity,
            });
            dynamicsChart.data.datasets[3].data.push({ x: t, y: nom.velocity });
          }

          // Efficient Update (No animation)
          systemsChart.update("none");
          dynamicsChart.update("none");
        });

        socket.on("disconnect", () => {
          document.getElementById("phase").textContent = "Telemetry Lost";
          document.getElementById("phase").style.color = "#ff3b30";
        });
      });
    </script>
  </body>
</html>
