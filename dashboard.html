<!DOCTYPE html>
<html>
  <head>
    <title>Lucre - Mission Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script
      src="https://cdn.socket.io/4.5.4/socket.io.min.js"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        background: #0a0a0a;
        color: white;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        text-align: center;
        padding: 20px;
      }
      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: linear-gradient(145deg, #1a1a1a, #151515);
        border-radius: 20px;
        padding: 40px;
        border: 1px solid #2a2a2a;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
      }
      h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
      }
      h2 {
        font-size: 1.4rem;
        margin-top: 40px;
        margin-bottom: 20px;
        color: #aaa;
        font-weight: 400;
        text-align: left;
      }
      .charts-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-top: 30px;
      }
      @media (max-width: 968px) {
        .charts-container {
          grid-template-columns: 1fr;
        }
      }
      .chart-wrapper {
        background: #1a1a1a;
        border-radius: 16px;
        padding: 25px;
        border: 1px solid #2a2a2a;
      }
      canvas {
        height: 400px !important;
      }
      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
        gap: 20px;
        margin: 30px 0;
      }
      .stat {
        background: linear-gradient(145deg, #252525, #1a1a1a);
        padding: 20px 15px;
        border-radius: 16px;
        font-size: 1rem;
        text-align: center;
        color: #888;
        border: 1px solid #2a2a2a;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        transition: transform 0.2s;
      }
      .stat:hover {
        transform: translateY(-2px);
      }
      .stat strong {
        display: block;
        font-size: 2.2rem;
        color: #fff;
        margin-top: 10px;
        font-weight: 600;
      }
      button {
        margin-top: 30px;
        padding: 16px 36px;
        background: linear-gradient(135deg, #007aff, #0056b3);
        color: white;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        font-size: 1.1rem;
        font-weight: 600;
        transition: all 0.3s;
      }
      button:hover {
        background: linear-gradient(135deg, #0056b3, #003d82);
        transform: translateY(-2px);
      }
      .phase {
        font-size: 1.6rem;
        margin: 20px 0;
        color: #00ff88;
        transition: color 0.3s ease;
        font-weight: 500;
      }
      .anomaly-alert {
        color: #ff3b30 !important;
        font-weight: bold;
        animation: pulse 1s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.02);
        }
      }
      .mode-badge {
        display: inline-block;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-left: 12px;
        text-transform: uppercase;
        letter-spacing: 1px;
        vertical-align: middle;
      }
      .mode-predictive {
        background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
        box-shadow: 0 2px 10px rgba(255, 107, 107, 0.3);
      }
      .mode-comparative {
        background: linear-gradient(135deg, #4facfe, #00f2fe);
        box-shadow: 0 2px 10px rgba(79, 172, 254, 0.3);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 id="missionTitle">Mission Dashboard</h1>
      <div class="phase" id="phase">Initializing Simulation...</div>
      <div class="stats">
        <div class="stat">Altitude<strong id="altitude">0.0 km</strong></div>
        <div class="stat">Velocity<strong id="velocity">0 m/s</strong></div>
        <div class="stat">Thrust<strong id="thrust">7607 kN</strong></div>
        <div class="stat">Propellant<strong id="fuel">100.00%</strong></div>
      </div>
      <div class="charts-container">
        <div class="chart-wrapper">
          <h2 id="systemsTitle">Propellant Analysis</h2>
          <canvas id="chartSystems"></canvas>
        </div>
        <div class="chart-wrapper">
          <h2>Flight Dynamics Comparison</h2>
          <canvas id="chartDynamics"></canvas>
        </div>
      </div>
      <button onclick="window.location.href='home.html'">Return to Hub</button>
    </div>

    <script>
      let socket;

      const fontConfig = {
        title: { font: { size: 13, weight: "500", family: "monospace" } },
        ticks: { font: { size: 11, family: "monospace" } },
        legend: { labels: { font: { size: 12, family: "sans-serif" } } },
      };

      const tooltipConfig = {
        enabled: true,
        backgroundColor: "rgba(20, 20, 20, 0.95)",
        titleFont: { size: 13, weight: "bold", family: "monospace" },
        bodyFont: { size: 12, family: "monospace" },
        padding: 12,
        cornerRadius: 6,
        borderColor: "#444",
        borderWidth: 1,
        displayColors: true,
        callbacks: {
          title: (tooltipItems) => `T+ ${tooltipItems[0].parsed.x.toFixed(1)}s`,
        },
      };

      const ctxSystems = document
        .getElementById("chartSystems")
        .getContext("2d");
      const systemsChart = new Chart(ctxSystems, {
        type: "line",
        data: { datasets: [] },
        options: {
          animation: false,
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: "index", intersect: false },
          scales: {
            x: {
              type: "linear",
              title: {
                display: true,
                text: "Mission Time (s)",
                color: "#999",
                ...fontConfig.title,
              },
              min: 0,
              max: 162,
              ticks: { color: "#777", stepSize: 20, ...fontConfig.ticks },
              grid: { color: "rgba(100, 100, 100, 0.2)", lineWidth: 1 },
              border: { color: "#555", width: 1 },
            },
            y: {
              title: {
                display: true,
                text: "Propellant %",
                color: "#999",
                ...fontConfig.title,
              },
              position: "left",
              min: 0,
              max: 100,
              ticks: { color: "#777", stepSize: 20, ...fontConfig.ticks },
              grid: { color: "rgba(100, 100, 100, 0.2)", lineWidth: 1 },
              border: { color: "#555", width: 1 },
            },
          },
          plugins: {
            legend: {
              ...fontConfig.legend,
              display: true,
              position: "top",
              align: "end",
              labels: {
                color: "#ccc",
                usePointStyle: false,
                boxWidth: 40,
                boxHeight: 2,
                padding: 15,
              },
            },
            tooltip: tooltipConfig,
          },
        },
      });

      const ctxDynamics = document
        .getElementById("chartDynamics")
        .getContext("2d");
      const dynamicsChart = new Chart(ctxDynamics, {
        type: "line",
        data: { datasets: [] },
        options: {
          animation: false,
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: "index", intersect: false },
          scales: {
            x: {
              type: "linear",
              title: {
                display: true,
                text: "Mission Time (s)",
                color: "#999",
                ...fontConfig.title,
              },
              min: 0,
              max: 162,
              ticks: { color: "#777", stepSize: 20, ...fontConfig.ticks },
              grid: { color: "rgba(100, 100, 100, 0.2)", lineWidth: 1 },
              border: { color: "#555", width: 1 },
            },
            y: {
              title: {
                display: true,
                text: "Altitude (km)",
                color: "#999",
                ...fontConfig.title,
              },
              position: "left",
              min: 0,
              max: 100,
              ticks: { color: "#777", stepSize: 20, ...fontConfig.ticks },
              grid: { color: "rgba(100, 100, 100, 0.2)", lineWidth: 1 },
              border: { color: "#555", width: 1 },
            },
            y1: {
              title: {
                display: true,
                text: "Velocity (m/s)",
                color: "#999",
                ...fontConfig.title,
              },
              position: "right",
              min: 0,
              max: 2500,
              ticks: { color: "#777", stepSize: 500, ...fontConfig.ticks },
              grid: {
                drawOnChartArea: false,
                color: "rgba(100, 100, 100, 0.2)",
              },
              border: { color: "#555", width: 1 },
            },
          },
          plugins: {
            legend: {
              ...fontConfig.legend,
              display: true,
              position: "top",
              align: "end",
              labels: {
                color: "#ccc",
                usePointStyle: false,
                boxWidth: 40,
                boxHeight: 2,
                padding: 15,
              },
            },
            tooltip: tooltipConfig,
          },
        },
      });

      window.addEventListener("load", () => {
        if (typeof io === "undefined") {
          document.getElementById("phase").textContent =
            "Error: Socket.IO not loaded";
          document.getElementById("phase").style.color = "#ff3b30";
          return;
        }

        socket = io("http://localhost:3000");

        const simMode = localStorage.getItem("simMode") || "predictive";
        const customParams =
          JSON.parse(localStorage.getItem("customRocketParams")) || {};

        const modeText =
          simMode === "predictive"
            ? "Predictive Analysis"
            : "Comparative Analysis";
        const modeBadge = `<span class="mode-badge mode-${simMode}">${simMode}</span>`;
        document.getElementById("missionTitle").innerHTML =
          modeText + modeBadge;

        if (simMode === "predictive") {
          document.getElementById("systemsTitle").textContent =
            "Propellant Anomaly Detection";
          systemsChart.data.datasets = [
            {
              label: "Actual Propellant (%)",
              data: [],
              borderColor: "#00d4ff",
              tension: 0.1,
              pointRadius: 0,
              borderWidth: 2.5,
            },
            {
              label: "Nominal Propellant",
              data: [],
              borderColor: "#888",
              tension: 0.1,
              pointRadius: 0,
              borderDash: [5, 5],
              borderWidth: 1.5,
            },
          ];
          dynamicsChart.data.datasets = [
            {
              label: "Altitude (km)",
              data: [],
              borderColor: "#ffaa00",
              yAxisID: "y",
              tension: 0.1,
              pointRadius: 0,
              borderWidth: 2.5,
            },
            {
              label: "Velocity (m/s)",
              data: [],
              borderColor: "#ff4466",
              yAxisID: "y1",
              tension: 0.1,
              pointRadius: 0,
              borderWidth: 2.5,
            },
          ];
        } else {
          document.getElementById("systemsTitle").textContent =
            "Propellant Comparison";
          systemsChart.data.datasets = [
            {
              label: "Your Rocket (%)",
              data: [],
              borderColor: "#00d4ff",
              tension: 0.1,
              pointRadius: 0,
              borderWidth: 2.5,
            },
            {
              label: "Falcon 9 (%)",
              data: [],
              borderColor: "#888",
              tension: 0.1,
              pointRadius: 0,
              borderDash: [5, 5],
              borderWidth: 1.5,
            },
          ];
          dynamicsChart.data.datasets = [
            {
              label: "Your Altitude",
              data: [],
              borderColor: "#ffaa00",
              yAxisID: "y",
              tension: 0.1,
              pointRadius: 0,
              borderWidth: 2.5,
            },
            {
              label: "F9 Altitude",
              data: [],
              borderColor: "rgba(255, 170, 0, 0.4)",
              yAxisID: "y",
              tension: 0.1,
              pointRadius: 0,
              borderDash: [5, 5],
              borderWidth: 1.5,
            },
            {
              label: "Your Velocity",
              data: [],
              borderColor: "#ff4466",
              yAxisID: "y1",
              tension: 0.1,
              pointRadius: 0,
              borderWidth: 2.5,
            },
            {
              label: "F9 Velocity",
              data: [],
              borderColor: "rgba(255, 68, 102, 0.4)",
              yAxisID: "y1",
              tension: 0.1,
              pointRadius: 0,
              borderDash: [5, 5],
              borderWidth: 1.5,
            },
          ];
        }

        systemsChart.update();
        dynamicsChart.update();

        socket.on("connect", () => {
          console.log("Connected to server");
          document.getElementById("phase").textContent =
            "Starting Simulation...";
          document.getElementById("phase").style.color = "#00ff88";
          socket.emit("start-simulation", {
            mode: simMode,
            params: customParams,
          });
          localStorage.removeItem("simMode");
          localStorage.removeItem("customRocketParams");
        });

        socket.on("data", (d) => {
          const displayData = d.display;
          const nominalData = d.nominal;

          document.getElementById("altitude").textContent = `${(
            displayData.altitude / 1000
          ).toFixed(1)} km`;
          document.getElementById("velocity").textContent = `${Math.round(
            displayData.velocity
          )} m/s`;
          document.getElementById("thrust").textContent = `${Math.round(
            displayData.thrust
          )} kN`;
          document.getElementById(
            "fuel"
          ).textContent = `${displayData.fuel.toFixed(2)}%`;

          const phaseEl = document.getElementById("phase");
          if (d.anomaly) {
            phaseEl.textContent = d.anomaly;
            phaseEl.classList.add("anomaly-alert");
          } else {
            phaseEl.classList.remove("anomaly-alert");
            phaseEl.textContent = `T+ ${d.time.toFixed(1)}s`;
            if (d.time < 70) phaseEl.style.color = "#00ff88";
            else if (displayData.fuel > 0) phaseEl.style.color = "#ff6600";
            else phaseEl.style.color = "#ff4444";
          }

          if (simMode === "predictive") {
            systemsChart.data.datasets[0].data.push({
              x: d.time,
              y: displayData.fuel,
            });
            systemsChart.data.datasets[1].data.push({
              x: d.time,
              y: nominalData.fuel,
            });
            dynamicsChart.data.datasets[0].data.push({
              x: d.time,
              y: displayData.altitude / 1000,
            });
            dynamicsChart.data.datasets[1].data.push({
              x: d.time,
              y: displayData.velocity,
            });
          } else {
            systemsChart.data.datasets[0].data.push({
              x: d.time,
              y: displayData.fuel,
            });
            systemsChart.data.datasets[1].data.push({
              x: d.time,
              y: nominalData.fuel,
            });
            dynamicsChart.data.datasets[0].data.push({
              x: d.time,
              y: displayData.altitude / 1000,
            });
            dynamicsChart.data.datasets[1].data.push({
              x: d.time,
              y: nominalData.altitude / 1000,
            });
            dynamicsChart.data.datasets[2].data.push({
              x: d.time,
              y: displayData.velocity,
            });
            dynamicsChart.data.datasets[3].data.push({
              x: d.time,
              y: nominalData.velocity,
            });
          }

          systemsChart.update("none");
          dynamicsChart.update("none");
        });

        socket.on("disconnect", () => {
          console.log("Disconnected");
          document.getElementById("phase").textContent = "Connection Lost";
          document.getElementById("phase").style.color = "#ff3b30";
        });
      });
    </script>
  </body>
</html>
